## 一个简单的引导程序的实现

------



[TOC]

------

用到的工具：nasm，Oracle VM VirtualBox

先上代码：

```assembly
        ORG        0x7c00            ; 指明程序装载地址

; 标准FAT12格式软盘专用的代码 Stand FAT12 format floppy code

        JMP        entry
        DB        0x90
        DB        "HELLOIPL"        ; 启动扇区名称（8字节）
        DW        512                ; 每个扇区（sector）大小（必须512字节）
        DB        1                ; 簇（cluster）大小（必须为1个扇区）
        DW        1                ; FAT起始位置（一般为第一个扇区）
        DB        2                ; FAT个数（必须为2）
        DW        224                ; 根目录大小（一般为224项）
        DW        2880            ; 该磁盘大小（必须为2880扇区1440*1024/512）
        DB        0xf0            ; 磁盘类型（必须为0xf0）
        DW        9                ; FAT的长度（必??9扇区）
        DW        18                ; 一个磁道（track）有几个扇区（必须为18）
        DW        2                ; 磁头数（必??2）
        DD        0                ; 不使用分区，必须是0
        DD        2880            ; 重写一次磁盘大小
        DB        0,0,0x29        ; 意义不明（固定）
        DD        0xffffffff        ; （可能是）卷标号码
        DB        "HELLO-OS   "    ; 磁盘的名称（必须为11字?，不足填空格）
        DB        "FAT12   "        ; 磁盘格式名称（必??8字?，不足填空格）
        TIMES     18 DB 0              ; 先空出18字节

; 程序主体

entry:
        MOV        AX,0            ; 初始化寄存器
        MOV        SS,AX
        MOV        SP,0x7c00
        MOV        DS,AX
        MOV        ES,AX

        MOV        SI,msg
putloop:
        MOV        AL,[SI]
        ADD        SI,1            ; 给SI加1
        CMP        AL,0
        JE        fin
        MOV        AH,0x0e            ; 显示一个文字
        MOV        BX,15            ; 指定字符颜色
        INT        0x10            ; 调用显卡BIOS
        JMP        putloop
fin:
        HLT                        ; 让CPU停止，等待指令
        JMP        fin                ; 无限循环

msg:
        DB        0x0a, 0x0a        ; 换行两次
		DB        "HELLO,WORLD"
		DB        0x0a
		DB        0x0d
		DB        0x0a
		DB        0x0a
		DB        "I am OS"
        DB        0x0a            ; 换行
        DB        0

        TIMES 510 - ($-$$) DB 0       ; 填写0x00直到0x001fe
        DB        0x55, 0xaa

; 启动扇区以外部分输出

        DB        0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
        TIMES     4600 DB 0 
        DB        0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
        TIMES     1469432  DB 0 

```

------

#### 第一部分：操作系统启动过程

1. **BIOS**

   - **硬件自检**
   - **移交控制权给下一阶段的启动程序**

2. **主引导记录**：读取第一顺位设备的第一个扇区，即前512个字节，若最后两个字节是0x55和0xaa则表明这是个启动程序。

   - **主引导记录的结构**：

     > （1） 第1-446字节：调用操作系统的机器码。
     >
     > （2） 第447-510字节：分区表（Partition table）。
     >
     > （3） 第511-512字节：主引导记录签名（0x55和0xAA）。

   - **分区表**：硬盘分区可以使每个区安装不同的操作系统，分区表长度只有64个字节，分成4项，每项16字节，因此一个硬盘最多有4个主分区，每个主分区的结构：

     > （1） 第1个字节：如果为0x80，就表示该主分区是激活分区，控制权要转交给这个分区。四个主分区里面只能有一个是激活的。
     >
     > （2） 第2-4个字节：主分区第一个扇区的物理位置（柱面、磁头、扇区号等等）。
     >
     > （3） 第5个字节：[主分区类型](http://en.wikipedia.org/wiki/Partition_type)。
     >
     > （4） 第6-8个字节：主分区最后一个扇区的物理位置。
     >
     > （5） 第9-12字节：该主分区第一个扇区的逻辑地址。
     >
     > （6） 第13-16字节：主分区的扇区总数。

     ​	最后的四个字节（"主分区的扇区总数"），决定了这个主分区的长度。也就是说，一个主分区的扇区总数最多不超过2的32次方。

     ​	如果每个扇区为512个字节，就意味着单个分区最大不超过2TB。再考虑到扇区的逻辑地址也是32位，所以单个硬盘可利用的空间最大也不超过2TB。如果想使用更大的硬盘，只有2个方法：一是提高每个扇区的字节数，二是[增加扇区总数](http://en.wikipedia.org/wiki/GUID_Partition_Table)。

3. **硬盘启动**：此时计算机控制权交由硬盘某个分区，有三种情况

   - **情况A：卷引导记录**

     ​	四个主分区里面，只有一个是激活的。计算机会读取激活分区的第一个扇区，叫做["卷引导记录](http://en.wikipedia.org/wiki/Volume_Boot_Record)"（Volume boot record，缩写为VBR）。

     ​	"卷引导记录"的主要作用是，告诉计算机，操作系统在这个分区里的位置。然后，计算机就会加载操作系统了。

   - **情况B：扩展分区和逻辑分区**

     ​	随着硬盘越来越大，四个主分区已经不够了，需要更多的分区。但是，分区表只有四项，因此规定有且仅有一个区可以被定义成"扩展分区"（Extended partition）。

     ​	所谓"扩展分区"，就是指这个区里面又分成多个区。这种分区里面的分区，就叫做"逻辑分区"（logical partition）。

     ​	计算机先读取扩展分区的第一个扇区，叫做["扩展引导记录"](http://en.wikipedia.org/wiki/Extended_partition)（Extended boot record，缩写为EBR）。它里面也包含一张64字节的分区表，但是最多只有两项（也就是两个逻辑分区）。

     ​	计算机接着读取第二个逻辑分区的第一个扇区，再从里面的分区表中找到第三个逻辑分区的位置，以此类推，直到某个逻辑分区的分区表只包含它自身为止（即只有一个分区项）。因此，扩展分区可以包含无数个逻辑分区。

     ​	但是，似乎很少通过这种方式启动操作系统。如果操作系统确实安装在扩展分区，一般采用下一种方式启动。

   - **情况C：启动管理器**

     ​	在这种情况下，计算机读取"主引导记录"前面446字节的机器码之后，不再把控制权转交给某一个分区，而是运行事先安装的["启动管理器"](http://en.wikipedia.org/wiki/Boot_loader#Modern_boot_loaders)（boot loader），由用户选择启动哪一个操作系统。

4. **操作系统**

   - 控制权转交给操作系统后，操作系统的内核首先被载入内存。随后启动各个模块，最后完成全部启动过程。

------

#### 第二部分：FAT12文件系统

![](C:\Users\Sean\Desktop\toyos\day02启动区\img\2019022023214560.gif.png)

​	FAT12是DOS时代就开始使用的文件系统(File System)，直到现在仍然在软盘上使用，FAT12软盘的被格式化后为：有两个磁头，每个磁头80个柱面（磁道），每个柱面有18个扇区，每个扇区512个字节空间。所以标准软盘的总空间为：

2 * 80 *18 * 512=1474560B=1440K=1.44M

##### 1、引导扇区

​	操作系统标识FAT12文件系统是因为在逻辑0扇区(即引导扇区)处还存储着一个特定的数据结构，此结构有固定的格式，在操作系统将此磁盘格式化时自动生成，具体数据结构如下表所示：

| 名称               | 开始字节 | 长度 | 内容                                  | 参考值                      |
| ------------------ | -------- | ---- | ------------------------------------- | --------------------------- |
| BS_jmpBOOT         | 0        | 3    | 一个短跳转指令                        | jmp short LABEL_START nop   |
| BS_OEMName         | 3        | 8    | 厂商名                                | 'ZGH'                       |
| BPB_BytesPerSec    | 11       | 2    | 每扇区字节数（Bytes/Sector）          | 0x200                       |
| BPB_SecPerClus     | 13       | 1    | 每簇扇区数（Sector/Cluster）          | 0x1                         |
| BPB_ResvdSecCnt    | 14       | 2    | Boot记录占用多少扇区                  | ox1                         |
| BPB_NumFATs        | 16       | 1    | 共有多少FAT表                         | 0x2                         |
| BPB_RootEntCnt     | 17       | 2    | 根目录区文件最大数                    | 0xE0                        |
| BPB_TotSec16       | 19       | 2    | 扇区总数                              | 0xB40                       |
| BPB_Media          | 21       | 1    | 介质描述符                            | 0xF0                        |
| BPB_FATSz16        | 22       | 2    | 每个FAT表所占扇区数                   | 0x9                         |
| BPB_SecPerTrk      | 24       | 2    | 每磁道扇区数（Sector/track）          | 0x12                        |
| BPB_NumHeads       | 26       | 2    | 磁头数（面数）                        | 0x2                         |
| BPB_HiddSec        | 28       | 4    | 隐藏扇区数                            | 0                           |
| BPB_TotSec32       | 32       | 4    | 如果BPB_TotSec16=0,则由这里给出扇区数 | 0                           |
| BS_DrvNum          | 36       | 1    | INT 13H的驱动器号                     | 0                           |
| BS_Reserved1       | 37       | 1    | 保留，未使用                          | 0                           |
| BS_BootSig         | 38       | 1    | 扩展引导标记(29h)                     | 0x29                        |
| BS_VolID           | 39       | 4    | 卷序列号                              | 0                           |
| BS_VolLab          | 43       | 11   | 卷标                                  | 'ZGH'                       |
| BS_FileSysType     | 54       | 8    | 文件系统类型                          | 'FAT12'                     |
| 引导代码及其他内容 | 62       | 448  | 引导代码及其他数据                    | 引导代码（剩余空间用0填充） |
| 结束标志0xAA55     | 510      | 2    | 第510字节为0x55，第511字节为0xAA      | 0xAA55                      |

其中的一些变量的含义：

| 变量           | 含义                                                         |
| -------------- | ------------------------------------------------------------ |
| BS_jmpBoot     | 是跳转指令，偏移0处的跳转指令必须是合法的可执行的基于x86的CPU指令，如：jmp  start，这样可以生成3字节长的指令，（加关键字short的短跳转指令的长度是2字节），指向操作系统引导代码部分。Windows和MS-DOS生成的FAT12启动扇区中的跳转指令是短跳转，如：jmp short LABEL_START，然后加一个nop的空指令来保持3字节的长度。 |
| BPB_BytsPerSec | 每扇区的字节数，类型是双字节长，标准分区上的每扇区字节数一般是512B， FAT12的格式下设置为512(0x200h)。 |
| BPB_SecPerClus | 每簇扇区数，偏移13处，类型是字节，簇是数据存储的最小单位，在FAT12格式下一般为1，即每簇只有1个扇区(512字节)。 |
| BPB_RsvdSecCnt | Boot记录占用多少扇区，即在FAT1之前的 引导扇区，一般情况下，引导扇区占用1个扇区。 |
| BPB_NumFATs    | 共有多少个FAT表，默认情况下此字段的值为2，也就是有两个FAT表，FAT1和FAT2的内容相同，当FAT1表出错的时候可以使用FAT2来恢复文件分配表。 |
| BPB_RootEntCnt | 根目录文件数最大值，默认为224，每个目录条目占用32B的空间，因此根目录的大小为：224*32/512=14，即占用14个扇区。 |
| BPB_TotSec16   | 扇区总数=0xB40=2880                                          |
| BPB_FATSz16    | 每个FAT占用的扇区数=0x9=9，即FAT1占用1—9逻辑扇区，FAT2占用10—18逻辑扇区。 |
| BPB_SecPerTrk  | 每磁道扇区数=0x12=18，即标准FAT12文件系统中，每个磁道的扇区数就是为18。 |
| BPB_NumHeads   | 磁头数=0x2=2，该磁盘包括2个磁头，也就是面数是2。             |

##### 2、FAT表

​     FAT1和FAT2是两个完全相同的FAT表，每个FAT占用9个扇区。其中FAT1占用1—9扇区，FAT2占用10—18扇区。

##### 3、根目录区

​	根目录区的开始扇区号是19，它是由若干个目录条目(Directory Entry)组成，条目最多有BPB_RootEntCnt个，由于根目录区的大小是依赖于BPB_RootEntCnt的，所以长度不固定。

​	在本FAT12中，因为BPB_RootEntCnt=0xE0=1416+0=244，即条目最多为244个，又因为每个条目占用32个字节，故24432/512=14，即该根目录区占14个扇区，即19—32。

​	 根目录区中的每个条目占用32字节，它的格式如下图

| 名称         | 偏移（字节） | 长度（字节数） | 描述                     |
| ------------ | ------------ | -------------- | ------------------------ |
| DIR_Name     | 0            | 0xB            | 文件名8字节，扩展名3字节 |
| DIR_Attr     | 0xB          | 1              | 文件属性                 |
| 保留位       | 0xC          | 10             | 保留位                   |
| DIR_WrtTime  | 0x16         | 2              | 最后一次写入时间         |
| DIR_WrtDate  | 0x18         | 2              | 最后一次写入日期         |
| DIR_FstClus  | 0x1A         | 2              | 此条目对应的开始簇数     |
| DIR_FileSize | 0x1C         | 4              | 文件大小                 |

##### 4、FAT表

​	对于大于512字节的文件来说，需要使用FAT表来寻找到该文件占用的所有数据区扇区。每12位成为一个FAT项(FAT Entry)，代表一个数据区中的簇。第0个和第1个FAT项始终不使用，第2个FAT项开始表示数据区的每一个簇，也就是说，第2个FAT项表示数据区第一个簇，依次类推。通常，FAT项的值代表的是文件的下一个簇号，但如果值大于或等于0xFF8，则表示当前簇已经是文件的最后一个簇了。如果值为0xFF7，表示它是一个坏簇。

------

#### 第三部分：运行

BIOS在开机时，系统会进入实模式，这个时候系统只用1M空间可以使用。具体分配情况如下：

> 0x00000—0x003FF中断向量表。
> 0x00400—0x004FF BIOS数据区。
> 0x00500—0x9FFFF 自由内存区。
> 0xA0000—0xbFFFF作为显存使用。
> 0xC0000—0xC7FFF 显卡BIOS。
> 0xC8000—0xCBFFF ide控制器BIOS使用。
> 0xF0000—0xFFFFF 系统bios使用。

在开机时，会自动将引导程序加载至0x7c00处。然后采用中断显示字符。

##### 1、汇编代码成img映像

只需要通过nasm自带的功能，通过命令：

```
nasm test.asm -o test.img
```

即可汇编成img文件

##### 2、虚拟机运行img映像

通过VM virtualBox即可运行img

![](C:\Users\Sean\Desktop\toyos\day02启动区\img\232.PNG)

### 完成引导程序的实现!

------

[1]: www.ruanyifeng.com/blog/2013/02/booting.html	"阮一峰——计算机是如何启动的？"

